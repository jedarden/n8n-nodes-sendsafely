name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: false
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
        default: auto

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      should_release: ${{ steps.bump.outputs.should_release }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch all tags
        run: |
          git fetch --tags --force
          echo "Available tags:"
          git tag -l | sort -V | tail -10

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version bump
        id: bump
        run: |
          # Get latest tag using git tag -l (works even after history rewrite)
          LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi
          echo "Latest tag: $LATEST_TAG"

          # Parse current version (strip 'v' prefix)
          VERSION="${LATEST_TAG#v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          echo "Current version: $MAJOR.$MINOR.$PATCH"

          # Determine bump type from input or commits
          BUMP_TYPE="${{ inputs.bump }}"
          if [ "$BUMP_TYPE" = "auto" ] || [ -z "$BUMP_TYPE" ]; then
            # Analyze commits since last tag
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

            if echo "$COMMITS" | grep -qiE "^(feat|feature)!:|BREAKING CHANGE"; then
              BUMP_TYPE="major"
            elif echo "$COMMITS" | grep -qiE "^(feat|feature)(\(.+\))?:"; then
              BUMP_TYPE="minor"
            else
              # Default to patch for fix:, chore:, docs:, or any other commit
              BUMP_TYPE="patch"
            fi
          fi

          echo "Bump type: $BUMP_TYPE"

          # Calculate new version
          case "$BUMP_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          NEW_TAG="v$NEW_VERSION"

          echo "New version: $NEW_VERSION"
          echo "New tag: $NEW_TAG"

          # Check if there are new commits since last tag
          COMMIT_COUNT=$(git rev-list ${LATEST_TAG}..HEAD --count 2>/dev/null || echo "1")
          if [ "$COMMIT_COUNT" = "0" ] && [ -z "${{ inputs.bump }}" ]; then
            echo "No new commits since $LATEST_TAG, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "new_version=$VERSION" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if tag already exists
          if git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
            echo "Tag $NEW_TAG already exists, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Create and push tag
          git tag -a "$NEW_TAG" -m "Release $NEW_VERSION"
          git push origin "$NEW_TAG"

  build:
    needs: version
    if: needs.version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Build package
        run: npm run build

      - name: Copy assets to dist
        run: |
          cp nodes/SendSafely/sendsafely.svg dist/nodes/SendSafely/
          cp nodes/SendSafely/SendSafely.node.json dist/nodes/SendSafely/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  github-release:
    needs: [version, build]
    if: needs.version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract changelog entry
        id: changelog
        run: |
          VERSION=${{ needs.version.outputs.new_version }}
          # Extract the section for this version from CHANGELOG.md
          sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d' > release_notes.md
          if [ ! -s release_notes.md ]; then
            echo "## Release ${VERSION}" > release_notes.md
            echo "" >> release_notes.md
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release_notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.new_version }}
          body_path: release_notes.md
          generate_release_notes: true
          draft: false

  publish-npm:
    needs: [version, build]
    if: needs.version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Update npm to latest (requires 11.5.1+ for trusted publishing)
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm ci

      - name: Update version in package.json
        run: npm version ${{ needs.version.outputs.new_version }} --no-git-tag-version --allow-same-version

      - name: Build package
        run: npm run build

      - name: Copy assets to dist
        run: |
          cp nodes/SendSafely/sendsafely.svg dist/nodes/SendSafely/
          cp nodes/SendSafely/SendSafely.node.json dist/nodes/SendSafely/

      - name: Publish with provenance (trusted publishing)
        run: npm publish --access public

      - name: Notify on success
        run: |
          echo "âœ… Successfully published n8n-nodes-sendsafely@${{ needs.version.outputs.new_version }} to npm"
          echo "ðŸ“¦ https://www.npmjs.com/package/n8n-nodes-sendsafely"
